var Game=function(){this.timeRemaining=0;this.state;this.lives;this.level;this.highScore;this.distanceToHighScore;this.highScoreCookieExpiry};Game.prototype.HIGH_SCORE_COOKIE_KEY="highScore";Game.prototype.State={TITLE:0,INSTRUCTIONS:1,LEVEL_TITLE:2,PLAY:3,PAUSED:4,GAME_OVER:5,DIED:6,WIN_LEVEL:7,REINCARNATE:8};Game.prototype.init=function(){map.init();enemyHandler.init();player.init();hud.init();var e=new Date;e.setFullYear(e.getFullYear()+15);this.highScoreCookieExpiry=e.toUTCString();var t=document.cookie;var n=t.indexOf(this.HIGH_SCORE_COOKIE_KEY);if(n>=0){var r=t.indexOf("=",n)+1;this.highScore=parseInt(t.substring(r))}else{this.highScore=0}this.setState(this.State.TITLE)};Game.prototype.setState=function(e){this.state=e;hud.setState(e);map.setState(e);enemyHandler.setState(e);player.setState(e);mapAccessories.setState(e);switch(e){case this.State.TITLE:this.lives=2;this.distanceToHighScore=this.highScore+1;break;case this.State.LEVEL_TITLE:case this.State.REINCARNATE:this.timeRemaining=2;break;case this.State.WIN_LEVEL:this.timeRemaining=2;map.setRows(0,map.Tile.WATER);this.setLevel(this.level+1);break;case this.State.DIED:this.timeRemaining=1;break}};Game.prototype.handleInput=function(e){switch(e){case"up":case"down":case"left":case"right":player.handleInput(e);break;case"pause":if(this.state===this.State.PLAY)this.setState(this.State.PAUSED);else if(this.state===this.State.PAUSED)this.setState(this.State.PLAY);break;case"space":if(this.state===this.State.TITLE)this.setState(this.State.INSTRUCTIONS);else if(this.state===this.State.INSTRUCTIONS){this.setLevel(1);this.setState(this.State.LEVEL_TITLE)}else if(this.state===this.State.GAME_OVER)this.setState(this.State.TITLE)}};Game.prototype.setLevel=function(e){if(--this.distanceToHighScore<0)document.cookie=this.HIGH_SCORE_COOKIE_KEY+"="+ ++this.highScore+"; expires="+this.highScoreCookieExpiry;this.level=e;switch(e){case 1:map.setRows(0,map.Tile.WATER,2,map.Tile.STONE,map.Tile.GRASS);mapAccessories.leftMostRockPosition=0;mapAccessories.leftMostKeyPosition=3;enemyHandler.setSpeeds(250,300);enemyHandler.setSpawnIntervalAndVariance(.75,.8);break;case 2:map.setRows(1,map.Tile.STONE,2,map.Tile.GRASS);mapAccessories.leftMostRockPosition=3;mapAccessories.leftMostKeyPosition=2;break;case 3:map.setRows(3,map.Tile.STONE);enemyHandler.setSpawnIntervalAndVariance(.4,.6);enemyHandler.setSpeeds(225,325);break;case 4:map.setRows(4,map.Tile.STONE);mapAccessories.leftMostRockPosition=3;enemyHandler.setSpawnIntervalAndVariance(.35,.4);break;case 5:map.setRows(2,map.Tile.STONE,3,map.Tile.GRASS);break;case 6:map.setRows(1,map.Tile.GRASS,3,map.Tile.STONE);mapAccessories.leftMostRockPosition=0;enemyHandler.setSpawnIntervalAndVariance(.4,.4);break;case 7:map.setRows(1,map.Tile.STONE,4,map.Tile.GRASS);mapAccessories.leftMostRockPosition=2;mapAccessories.leftMostKeyPosition=3;break;case 8:map.setRows(4,map.Tile.STONE);break;default:enemyHandler.setSpawnIntervalAndVariance(enemyHandler.spawnInterval*.98,enemyHandler.spawnVariance*.99);enemyHandler.setSpeeds(enemyHandler.lowerSpeedLimit*1.04,enemyHandler.upperSpeedLimit*1.06);if(e===12)mapAccessories.leftMostKeyPosition=2;else if(e===15)mapAccessories.leftMostKeyPosition=1;else if(e===18)mapAccessories.leftMostRockPosition=1}};Game.prototype.died=function(){if(--this.lives>=0)this.setState(this.State.REINCARNATE);else this.setState(this.State.GAME_OVER)};Game.prototype.extraLife=function(){this.lives++;hud.extraLife()};Game.prototype.decrementTimer=function(e){if((this.timeRemaining-=e)<=0){switch(this.state){case this.State.LEVEL_TITLE:case this.State.REINCARNATE:this.setState(this.State.PLAY);break;case this.State.WIN_LEVEL:this.setState(this.State.LEVEL_TITLE);break;case this.State.DIED:this.died();break}}};Game.prototype.update=function(e,t){enemyHandler.update(e,t);player.update(e,t);map.update(e,t);if(this.timeRemaining>0)this.decrementTimer(e)};Game.prototype.render=function(){ctx.clearRect(0,0,canvas.width,canvas.height);map.render();mapAccessories.render();player.render();enemyHandler.render();hud.render()};var Map=function(){this.tileTypes=[];this.tileCoordinates=[];this.roadRowNumbers=[];this.pendingTileChanges={status:null,changes:[]}};Map.prototype.ROWS_COUNT=6;Map.prototype.COLUMN_COUNT=5;Map.prototype.ROW_HEIGHT_PIXELS=83;Map.prototype.COL_WIDTH_PIXELS=101;Map.prototype.IMAGE_URL_ARRAY=["images/water-block.png","images/stone-block.png","images/grass-block.png"];Map.prototype.Tile={WATER:0,STONE:1,GRASS:2};Map.prototype.AnimationState={CONTAINS_NEW_CHANGES:0,ANIMATE:1,NOTHING_TO_ANIMATE:2};Map.prototype.init=function(){var e,t;var n=[];for(e=0;e<this.ROWS_COUNT;e++){if(e===0)n.push(this.Tile.WATER);else n.push(this.Tile.GRASS)}for(t=0;t<this.COLUMN_COUNT;t++){this.tileCoordinates.push([]);this.tileTypes.push([]);var r=t*this.COL_WIDTH_PIXELS;for(e=0;e<this.ROWS_COUNT;e++){var i={x:t*this.COL_WIDTH_PIXELS,y:e*this.ROW_HEIGHT_PIXELS};this.tileCoordinates[t].push(i);this.tileTypes[t].push(n[e])}}this.pendingTileChanges.status=this.AnimationState.NOTHING_TO_ANIMATE};Map.prototype.setState=function(e){switch(e){case game.State.TITLE:this.setRows(0,this.Tile.WATER,[1,2,3,4],this.Tile.STONE,map.Tile.GRASS);break}};Map.prototype.pixelCoordinatesForBoardCoordinates=function(e,t){var n={};var r=this.tileCoordinates[e][t];for(var i in r){if(r.hasOwnProperty(i))n[i]=r[i]}return n};Map.prototype.setRows=function(e){var t=Array.prototype.slice.call(arguments);var n=[];var r,i;for(var s=this.ROWS_COUNT-1;s>=0;s--){n.splice(0,0,s)}while(t.length>1){if(t[0].constructor===Number)r=[t.splice(0,1)[0]];else r=t.splice(0,1)[0];i=t.splice(0,1)[0];for(var s=r.length-1;s>=0;s--){this.setRow(r[s],i);n.splice(n.indexOf(r[s]),1)}}if(t.length>0){i=t[0];while(n.length>0)this.setRow(n.pop(),i)}};Map.prototype.setRow=function(e,t){if(t===this.Tile.STONE){if(this.roadRowNumbers.indexOf(e)===-1){this.roadRowNumbers.push(e)}else{return}}else{var n=this.roadRowNumbers.indexOf(e);if(n!==-1){this.roadRowNumbers.splice(n,1)}}for(var r=this.COLUMN_COUNT-1;r>=0;r--){this.setTile(r,e,t)}};Map.prototype.setTile=function(e,t,n){switch(game.state){case game.State.PLAY:case game.State.TITLE:this.tileTypes[e][t]=n;break;default:if(this.tileTypes[e][t]!=n)this.addTileChangeToPending(e,t,n)}};Map.prototype.addTileChangeToPending=function(e,t,n){this.pendingTileChanges.changes.push({location:{column:e,row:t},tileType:n,time:Math.random()});this.pendingTileChanges.status=this.AnimationState.CONTAINS_NEW_CHANGES};Map.prototype.update=function(e,t){var n;switch(this.pendingTileChanges.status){case this.AnimationState.NOTHING_TO_ANIMATE:break;case this.AnimationState.CONTAINS_NEW_CHANGES:n=this.pendingTileChanges.changes;n.sort(function(e,t){return e.time-t.time});var r=0;var i=n[n.length-1].time;n.forEach(function(e){r=e.time+=r});i+=r;n.forEach(function(e){e.time*=game.timeRemaining*9/i/10;e.time+=t});this.pendingTileChanges.status=this.AnimationState.ANIMATE;case this.AnimationState.ANIMATE:n=this.pendingTileChanges.changes;var s,o;while(n.length>0&&t>=n[0].time){s=n.splice(0,1)[0];o=s.location;this.tileTypes[o.column][o.row]=s.tileType}if(n.length===0)this.pendingTileChanges.status=this.AnimationState.NOTHING_TO_ANIMATE}};Map.prototype.randomRoadYCoordinate=function(){var e=Math.floor(Math.random()*this.roadRowNumbers.length);var t=this.roadRowNumbers[e];return this.pixelCoordinatesForBoardCoordinates(0,t).y};Map.prototype.randomRoadBoardLocation=function(){return{column:Math.floor(Math.random()*map.COLUMN_COUNT),row:this.roadRowNumbers[Math.floor(Math.random()*this.roadRowNumbers.length)]}};Map.prototype.randomBoardLocationInRows=function(e){var t=Array.prototype.slice.call(arguments);var n;if(t.length===0)n=Math.floor(Math.random()*this.ROWS_COUNT);else if(t[0].constructor===Array)n=t[0][Math.floor(Math.random()*t.length)];else n=t[Math.floor(Math.random()*t.length)];return{column:Math.floor(Math.random()*this.COLUMN_COUNT),row:n}};Map.prototype.playerCanMoveHere=function(e,t){if(mapAccessories.playerCanMoveHere(e,t)&&e<this.COLUMN_COUNT&&e>=0&&t<this.ROWS_COUNT&&t>=0){if(t===0&&this.tileTypes[e][t]!==this.Tile.WATER)game.setState(game.State.WIN_LEVEL);return true}return false};Map.prototype.render=function(){var e,t;for(var n=0;n<this.ROWS_COUNT;n++){for(var r=0;r<this.COLUMN_COUNT;r++){e=this.tileCoordinates[r][n];t=Resources.get(this.IMAGE_URL_ARRAY[this.tileTypes[r][n]]);ctx.drawImage(t,e.x,e.y)}}};var MapAccessories=function(){this.accessories=[];this.rockAccessory;this.keyAccessory;this.heartAccessory;this.hidden=true;this.leftMostRockPosition=0;this.leftMostKeyPosition=0};MapAccessories.prototype.Type={KEY:0,ROCK:1,HEART:2};MapAccessories.prototype.IMAGE_URL_ARRAY=["images/Key.png","images/Rock.png","images/Heart.png"];MapAccessories.prototype.ROCK_PIXEL_ADJUST=-25;MapAccessories.prototype.KEY_PIXEL_ADJUST=-15;MapAccessories.prototype.PROBABILITY_OF_EXTRA_LIFE=1/20;MapAccessories.prototype.placeAccessories=function(){if(this.accessories.indexOf(this.rockAccessory)!==-1&&this.accessories.indexOf(this.keyAccessory)!==-1)return;this.accessories=[];var e=map.randomBoardLocationInRows(0);while(e.column<this.leftMostRockPosition)e=map.randomBoardLocationInRows(0);map.setTile(e.column,e.row,map.Tile.STONE);this.rockAccessory=this.packageAccessory(this.Type.ROCK,e);this.rockAccessory.coordinates.y+=this.ROCK_PIXEL_ADJUST;var t=map.randomRoadBoardLocation();while(t.column<this.leftMostKeyPosition)t=map.randomRoadBoardLocation();this.keyAccessory=this.packageAccessory(this.Type.KEY,t);this.keyAccessory.coordinates.y+=this.KEY_PIXEL_ADJUST;this.accessories.splice(0,0,this.rockAccessory,this.keyAccessory);if(Math.random()<=this.PROBABILITY_OF_EXTRA_LIFE){var n=map.randomRoadBoardLocation();while(n.column===t.column&&n.row===t.row)n=map.randomRoadBoardLocation();this.heartAccessory=this.packageAccessory(this.Type.HEART,n);this.accessories.push(this.heartAccessory)}};MapAccessories.prototype.packageAccessory=function(e,t){return{accessoryType:e,location:t,coordinates:map.pixelCoordinatesForBoardCoordinates(t.column,t.row)}};MapAccessories.prototype.playerCanMoveHere=function(e,t){if(this.accessories.indexOf(this.rockAccessory)!==-1&&this.rockAccessory.location.column===e&&this.rockAccessory.location.row===t)return false;else if(this.heartAccessory&&this.heartAccessory.location.column===e&&this.heartAccessory.location.row===t){this.accessories.splice(this.accessories.indexOf(this.heartAccessory),1);this.heartAccessory=null;game.extraLife()}else if(this.keyAccessory.location.column===e&&this.keyAccessory.location.row===t){this.accessories.splice(this.accessories.indexOf(this.rockAccessory),1);this.accessories.splice(this.accessories.indexOf(this.keyAccessory),1)}return true};MapAccessories.prototype.setState=function(e){switch(e){case game.State.LEVEL_TITLE:this.hidden=true;this.placeAccessories();break;case game.State.REINCARNATE:this.hidden=true;this.accessories.splice(0,0,this.rockAccessory,this.keyAccessory);break;case game.State.PLAY:this.hidden=false;break;case game.State.DIED:this.hidden=false;this.heartAccessory=null;this.accessories=[];break;case game.State.GAME_OVER:this.hidden=true;this.rockAccessory=null;this.keyAccessory=null;this.accessories=[];break;default:this.hidden=true}};MapAccessories.prototype.render=function(){if(!this.hidden){var e,t;this.accessories.forEach(function(n){e=Resources.get(this.IMAGE_URL_ARRAY[n.accessoryType]);t=n.coordinates;ctx.drawImage(e,t.x,t.y)},this)}};var HeadsUp=function(){this.levelText;this.livesText;this.bigText;this.bigTextSize;this.instructionText};HeadsUp.prototype.TYPEFACE="Impact";HeadsUp.prototype.GAME_TITLE="PHROGGER";HeadsUp.prototype.GAME_INSTRUCTIONS=["Use arrow keys to get across the road","Don't forget to grab the key!","Press P to pause","","When you're ready, hit the spacebar"];HeadsUp.prototype.levelPrefix="LEVEL: ";HeadsUp.prototype.livesPrefix="LIVES: ";HeadsUp.prototype.TITLE_TEXT_SIZE=80;HeadsUp.prototype.PAUSED_TEXT_SIZE=36;HeadsUp.prototype.PRE_LEVEL_TEXT_SIZE=48;HeadsUp.prototype.LEVEL_TEXT_SIZE=16;HeadsUp.prototype.LIVES_TEXT_SIZE=16;HeadsUp.prototype.INSTRUCTION_TEXT_SIZE=20;HeadsUp.prototype.INSTRUCTION_LINE_HEIGHT=24;HeadsUp.prototype.LEVEL_X=0;HeadsUp.prototype.LEVEL_Y=(Map.prototype.ROWS_COUNT+1)*Map.prototype.ROW_HEIGHT_PIXELS+25;HeadsUp.prototype.LIVES_X=Map.prototype.COLUMN_COUNT*Map.prototype.COL_WIDTH_PIXELS;HeadsUp.prototype.LIVES_Y=(Map.prototype.ROWS_COUNT+1)*Map.prototype.ROW_HEIGHT_PIXELS+25;HeadsUp.prototype.init=function(){this.BIG_TEXT_X=canvas.width/2;this.BIG_TEXT_Y=canvas.height/2-20;this.INSTRUCTIONS_X=canvas.width/2;this.INSTRUCTIONS_Y=canvas.height/2+20};HeadsUp.prototype.setState=function(e){switch(e){case game.State.TITLE:this.levelText="";this.livesText="";this.bigText=this.GAME_TITLE;this.bigTextSize=this.TITLE_TEXT_SIZE;this.instructionText=["Press spacebar to begin","",game.highScore>0?"High score: Level "+game.highScore:""];break;case game.State.INSTRUCTIONS:this.bigText="";this.instructionText=this.GAME_INSTRUCTIONS;break;case game.State.LEVEL_TITLE:case game.State.REINCARNATE:this.bigText=this.levelPrefix+game.level;this.instructionText=this.livesPrefix+game.lives;this.bigTextSize=this.PRE_LEVEL_TEXT_SIZE;this.levelText="";this.livesText="";break;case game.State.PLAY:this.levelText=this.levelPrefix+game.level;this.livesText=this.livesPrefix+game.lives;this.bigText="";this.instructionText="";break;case game.State.PAUSED:this.bigText="PAUSED";this.bigTextSize=this.PAUSED_TEXT_SIZE;break;case game.State.WIN_LEVEL:var t=["Nicely done!","You rock!","Ka-Blamo"];this.bigText=t[Math.floor(Math.random()*t.length)];break;case game.State.DIED:var n=["You died","You expired","You perished","Kicked the bucket","Croaked","Bought it","Bought the farm","Checked out early"];this.bigText=n[Math.floor(Math.random()*n.length)];break;case game.State.GAME_OVER:this.bigText="Game over";if(game.distanceToHighScore<0&&-game.distanceToHighScore!==game.highScore)this.instructionText=["You beat your high score!","","New high score:","Level "+game.highScore];else if(game.distanceToHighScore<0)this.instructionText=["You set your first high score!","","High Score: Level "+game.highScore];else if(game.distanceToHighScore===0&&game.highScore>0)this.instructionText=["You tied your high score!","","Give it another try!"];else this.instructionText=["So sad"];this.instructionText.splice(1e3,0,"","Press spacebar to continue");break}};HeadsUp.prototype.extraLife=function(){this.livesText=this.livesPrefix+game.lives};HeadsUp.prototype.render=function(){if(this.bigText){this.renderText(this.bigText,this.BIG_TEXT_X,this.BIG_TEXT_Y,this.TITLE_TEXT_SIZE,this.TYPEFACE,"center")}if(this.instructionText){if(this.instructionText.constructor==Array){for(var e=this.instructionText.length-1;e>=0;e--){this.renderText(this.instructionText[e],this.INSTRUCTIONS_X,this.INSTRUCTION_LINE_HEIGHT*e+this.INSTRUCTIONS_Y,this.INSTRUCTION_TEXT_SIZE,this.TYPEFACE,"center")}}else{this.renderText(this.instructionText,this.INSTRUCTIONS_X,this.INSTRUCTIONS_Y,this.INSTRUCTION_TEXT_SIZE,this.TYPEFACE,"center")}}if(this.levelText){this.renderText(this.levelText,this.LEVEL_X,this.LEVEL_Y,this.LEVEL_TEXT_SIZE,this.TYPEFACE,"left")}if(this.livesText){this.renderText(this.livesText,this.LIVES_X,this.LIVES_Y,this.LIVES_TEXT_SIZE,this.TYPEFACE,"right")}};HeadsUp.prototype.renderText=function(e,t,n,r,i,s){ctx.font=r+"pt "+i;ctx.textAlign=s;ctx.fillText(e,t,n,canvas.width);ctx.strokeText(e,t,n,canvas.width)};var Enemy=function(){this.x;this.y;this.hidden;this.speed};Enemy.prototype.SPRITE="images/enemy-bug.png";Enemy.prototype.PIXEL_ADJUST=-20;Enemy.prototype.EDGE_ADJUST_RIGHT=5;Enemy.prototype.EDGE_ADJUST_LEFT=36;Enemy.prototype.init=function(e,t,n,r){this.speed=Math.random()*(r-n)+n;this.x=e;this.y=t+this.PIXEL_ADJUST;this.hidden=false};Enemy.prototype.update=function(e,t){this.x+=this.speed*e};Enemy.prototype.render=function(){if(!this.hidden)ctx.drawImage(Resources.get(this.SPRITE),this.x,this.y)};var EnemyHandler=function(){this.activeEnemies=[];this.retiredEnemies=[];this.spawnInterval;this.spawnVariance;this.timeUntilSpawn=0;this.moveable=true;this.hidden=false;this.activeEnemiesByRow={};this.potentialCollisionLocation={column:null,rowIndex:null};this.timePaused=0;this.spawnX;this.retireX};EnemyHandler.prototype.init=function(){this.spawnX=map.pixelCoordinatesForBoardCoordinates(0,0).x-map.COL_WIDTH_PIXELS;this.retireX=map.pixelCoordinatesForBoardCoordinates(map.COLUMN_COUNT-1,0).x+map.COL_WIDTH_PIXELS};EnemyHandler.prototype.MAX_SPAWN_ATTEMPTS=10;EnemyHandler.prototype.setState=function(e){switch(e){case game.State.TITLE:this.moveable=true;this.hidden=false;this.setSpeeds(200,500);this.setSpawnIntervalAndVariance(.3,.5);break;case game.State.INSTRUCTIONS:this.moveable=true;this.hidden=false;break;case game.State.LEVEL_TITLE:case game.State.REINCARNATE:this.moveable=true;this.hidden=false;break;case game.State.PLAY:this.moveable=true;this.hidden=false;break;case game.State.PAUSED:this.moveable=false;this.hidden=true;break;case game.State.DIED:this.moveable=false;this.hidden=false;break}};EnemyHandler.prototype.setSpawnIntervalAndVariance=function(e,t){if(this.timeUntilSpawn>(this.spawnInterval=e)*((this.spawnVariance=t)+1))this.newTimeUntilSpawn()};EnemyHandler.prototype.setSpeeds=function(e,t){this.lowerSpeedLimit=e;this.upperSpeedLimit=t};EnemyHandler.prototype.update=function(e,t){if(this.moveable){if(this.timePaused>0){this.activeEnemies.forEach(function(e){e.retireTime+=this.timePaused},this);map.roadRowNumbers.forEach(function(e){var t=map.pixelCoordinatesForBoardCoordinates(0,e).y+Enemy.prototype.PIXEL_ADJUST;if(this.activeEnemiesByRow[t]!==undefined){this.activeEnemiesByRow[t].forEach(function(e){for(var t=e.entryTimes.length-1;t>=0;t--){e.entryTimes[t]+=this.timePaused}for(var t=e.exitTimes.length-1;t>=0;t--){e.exitTimes[t]+=this.timePaused}},this)}},this);player.addPauseTimeToCollision(this.timePaused);this.timePaused=0}var n;while(this.activeEnemies.length>0&&t>=this.activeEnemies[0].retireTime){n=this.activeEnemies.splice(0,1)[0];this.retiredEnemies.push(n);this.activeEnemiesByRow[n.enemy.y].splice(0,1)}for(var r=this.activeEnemies.length-1;r>=0;r--){this.activeEnemies[r].enemy.update(e,t)}if((this.timeUntilSpawn-=e)<=0){this.spawnNewEnemy()}}else{this.timePaused+=e}};EnemyHandler.prototype.getNewEnemy=function(){var e;if(!(e=this.retiredEnemies.pop()))e={enemy:new Enemy,retireTime:null};var t=map.randomRoadYCoordinate();e.enemy.init(this.spawnX,t,this.lowerSpeedLimit,this.upperSpeedLimit);return e};EnemyHandler.prototype.spawnNewEnemy=function(e){if((e=e||0)<this.MAX_SPAWN_ATTEMPTS){var t=this.getNewEnemy();var n=t.enemy;var r=this.packageEnemyWithEntryAndExitTimes(n);var i=r.entryTimes;var s=n.y;var o=i[map.COLUMN_COUNT+1];var u=this.activeEnemiesByRow[s];if(u===undefined){u=[];this.activeEnemiesByRow[s]=u}if(u.length>0){var a=u[u.length-1].entryTimes;var f=a[map.COLUMN_COUNT+1];var l=i[map.COLUMN_COUNT];if(l<f){this.retiredEnemies.push(t);this.spawnNewEnemy(e+1);return}var c=a[1];var h=i[0];if(h<c){this.retiredEnemies.push(t);this.spawnNewEnemy(e+1);return}}if(this.potentialCollisionLocation.rowIndex===s)player.newEnemyInRow(i[this.potentialCollisionLocation.column]);this.activeEnemiesByRow[s].push(r);t.retireTime=o;this.activeEnemies.push(t)}this.newTimeUntilSpawn()};EnemyHandler.prototype.newTimeUntilSpawn=function(){this.timeUntilSpawn=this.spawnInterval*(this.spawnVariance*(2*Math.random()-1)+1)};EnemyHandler.prototype.packageEnemyWithEntryAndExitTimes=function(e){var t=[];var n=[];var r=map.COL_WIDTH_PIXELS/e.speed;var i=(e.EDGE_ADJUST_RIGHT+player.EDGE_ADJUST_LEFT)/e.speed;var s=(e.EDGE_ADJUST_LEFT+player.EDGE_ADJUST_RIGHT)/e.speed;var o=Date.now()/1e3;for(var u=map.COLUMN_COUNT+1;u>=0;u--){t.splice(0,0,u*r+i+o);n.splice(0,0,(u+2)*r-s+o)}return{enemy:e,entryTimes:t,exitTimes:n}};EnemyHandler.prototype.collisionTimeForCoordinates=function(e,t){if(e===undefined){this.potentialCollisionLocation.column=null;this.potentialCollisionLocation.rowIndex=null;return null}var n=map.pixelCoordinatesForBoardCoordinates(e,t).y+Enemy.prototype.PIXEL_ADJUST;this.potentialCollisionLocation.column=e;this.potentialCollisionLocation.rowIndex=n;var r=this.activeEnemiesByRow[n];if(r===undefined)return;var i;var s;var o;var u=Date.now()/1e3;for(var a=0;a<r.length;a++){i=r[a];s=i.entryTimes[e];o=i.exitTimes[e];if(s>u){return s}else if(o>u){player.die();return}}return};EnemyHandler.prototype.render=function(){if(!this.hidden){this.activeEnemies.forEach(function(e){e.enemy.render()})}};var Player=function(){this.row=4;this.column=1;this.hidden=false;this.moveable=false;this.collisionDetectionOn=false;this.collisionTime};Player.prototype.SPRITE="images/char-boy.png";Player.prototype.PIXEL_ADJUST=-15;Player.prototype.EDGE_ADJUST_RIGHT=29;Player.prototype.EDGE_ADJUST_LEFT=30;Player.prototype.init=function(){this.setPosition(this.column,this.row)};Player.prototype.setState=function(e){switch(e){case game.State.TITLE:this.hidden=false;this.moveable=false;this.setPosition((map.COLUMN_COUNT-1)/2,map.ROWS_COUNT-1);this.collisionDetectionOn=false;break;case game.State.INSTRUCTIONS:case game.State.LEVEL_TITLE:case game.State.REINCARNATE:this.hidden=false;this.moveable=false;this.setPosition((map.COLUMN_COUNT-1)/2,map.ROWS_COUNT-1);break;case game.State.PLAY:this.collisionDetectionOn=true;this.hidden=false;this.moveable=true;break;case game.State.PAUSED:this.collisionDetectionOn=false;this.hidden=true;this.moveable=false;break;case game.State.DIED:this.collisionDetectionOn=false;this.hidden=false;this.moveable=false;case game.State.WIN_LEVEL:this.collisionDetectionOn=false;this.moveable=false;this.hidden=false}};Player.prototype.update=function(e,t){if(this.collisionDetectionOn&&this.collisionTime&&t>this.collisionTime){this.die()}};Player.prototype.render=function(){if(!this.hidden)ctx.drawImage(Resources.get(this.SPRITE),this.x,this.y)};Player.prototype.setPosition=function(e,t){this.column=Math.min(Math.max(e,0),map.COLUMN_COUNT-1);this.row=Math.min(Math.max(t,0),map.ROWS_COUNT-1);var n=map.pixelCoordinatesForBoardCoordinates(this.column,this.row);this.x=n.x;this.y=n.y+this.PIXEL_ADJUST;switch(map.tileTypes[this.column][this.row]){case map.Tile.STONE:this.collisionTime=enemyHandler.collisionTimeForCoordinates(this.column,this.row);break;case map.Tile.WATER:this.die();case map.Tile.GRASS:this.collisionTime=enemyHandler.collisionTimeForCoordinates();break}};Player.prototype.newEnemyInRow=function(e){if(!this.collisionTime)this.collisionTime=e};Player.prototype.addPauseTimeToCollision=function(e){if(this.collisionTime)this.collisionTime+=e};Player.prototype.die=function(){game.setState(game.State.DIED)};Player.prototype.handleInput=function(e){if(this.moveable){switch(e){case"left":case"right":case"up":case"down":this.move(e)}}};Player.prototype.move=function(e){var t=this.column,n=this.row;switch(e){case"left":t--;break;case"right":t++;break;case"up":n--;break;case"down":n++;break}if(map.playerCanMoveHere(t,n))this.setPosition(t,n)};var map=new Map;var mapAccessories=new MapAccessories;var enemyHandler=new EnemyHandler;var hud=new HeadsUp;var player=new Player;var game=new Game;document.addEventListener("keydown",function(e){var t={32:"space",37:"left",38:"up",39:"right",40:"down",80:"pause"};var n=t[e.keyCode];if(n!==undefined)game.handleInput(n)})